# Installs and configures packages for mpi

- name: "Install MPI on master"
  hosts: master
  vars:
    mpi_reinstall_from_source: false
    mpi_major_version: 4.1
    mpi_minor_version: 4.1.3
    mpi_sha256sum: sha256:9c0fd1f78fc90ca9b69ae4ab704687d5544220005ccd7678bf58cc13135e67e0
    mpi_link: https://download.open-mpi.org/release/open-mpi/v{{mpi_major_version}}/openmpi-{{mpi_minor_version}}.tar.gz
  tasks:
    - name: Ensure Packages Are Present
      become: true
      yum:
        name: gcc-c++
        state: present

    - name: Get MPI Version
      command: mpirun --version
      ignore_errors: true
      changed_when: false
      failed_when: false
      register: mpi_installed_version

    - name: Assert MPI Version Correct
      set_fact:
        mpi_reinstall_from_source: true
      when: mpi_installed_version is failed or (not mpi_minor_version in mpi_installed_version.stdout)

    - when: mpi_reinstall_from_source
      block:
        - name: Download OpenMPI
          get_url:
            url: "{{mpi_link}}"
            dest: "/tmp/openmpi-{{mpi_minor_version}}.tar.gz"
            checksum: "{{mpi_sha256sum}}"

        - name: Extract archive
          unarchive:
            src: "/tmp/openmpi-{{mpi_minor_version}}.tar.gz"
            dest: /tmp/
            copy: false

        - name: Configure install
          command: ./configure --prefix=/usr/local
          args:
            chdir: "/tmp/openmpi-{{mpi_minor_version}}"

        - name: Build MPI
          command: make -j all
          args:
            chdir: "/tmp/openmpi-{{mpi_minor_version}}"

        - name: Install MPI
          become: true
          command: make install
          args:
            chdir: "/tmp/openmpi-{{mpi_minor_version}}"

        - name: Remove build directory
          file:
            path: "/tmp/openmpi-{{mpi_minor_version}}"
            state: absent

        - name: Remove archive
          file:
            path: "/tmp/openmpi-{{mpi_minor_version}}.tar.gz"
            state: absent

        - name: Update Libraries
          become: true
          command: ldconfig

- name: "Install MPI on workers"
  hosts: workers
  vars:
    have_mpi_directory: false
    mpi_major_version: 4.1
    mpi_minor_version: 4.1.3
    mpi_sha256sum: sha256:9c0fd1f78fc90ca9b69ae4ab704687d5544220005ccd7678bf58cc13135e67e0
    mpi_link: https://download.open-mpi.org/release/open-mpi/v{{mpi_major_version}}/openmpi-{{mpi_minor_version}}.tar.gz
  tasks:
    - name: Ensure Packages Are Present
      become: true
      yum:
        name: gcc-c++
        state: present

    - name: Check for MPI directory on main
      delegate_to: localhost
      stat:
        path: /home/{{ansible_user_id}}/openmpi-installs/openmpi-{{mpi_minor_version}}
      register: have_mpi_install_for_workers

    - name: Assert we have MPI directory
      fail:
        msg: Could not find OpenMPI directory to copy to workers. Build OpenMPI on worker and copy back.
      when: not have_mpi_install_for_workers

    - name: Copy Openmpi to worker
      copy:
        src: /home/{{ansible_user_id}}/openmpi-installs/openmpi-{{mpi_minor_version}}
        dest: /opt/
        directory_mode:
      tags:
        - parentdir

    - name: Update Libraries
      become: true
      command: ldconfig
